<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>FlightHop</title>
    <meta name="description" content="Flight search via Google Flight API with Facebook login">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    <!-- <link rel="stylesheet" href="style.css"> -->
  </head>
  <body>
    <div id="app">
      <form>
        Airports: <input
          type="text"
          placeholder="enter codes to search"
          id="textCodes"
          style="width: 150px;"
        />
        <input
          type="button"
          value="Find
          Flights"
          id="btnSubmitCodes"
          style="width: 60px;"
          onClick="onSubmitCodes()"
        />
      </form>
    </div>
<script>
/* global axios, X2JS */
let x2js;

const el = {};
el.textCodes = document.getElementById('textCodes');
el.btnSubmitCodes = document.getElementById('btnSubmitCodes');

const getUserLoc = () => new Promise((resolve, reject) =>
  navigator.geolocation.getCurrentPosition(({ coords }) =>
    resolve([coords.latitude, coords.longitude])));

const getAirportCodes = (geo, dist) => {
  const lat = geo[0] || 37.7718305;
  const lng = geo[1] || -122.4411147;
  dist = dist || 20;

  // could add &fields=station_id param
  const url = `http://aviationweather.gov/adds/dataserver_current/httpparam?dataSource=stations&requestType=retrieve&format=xml&radialDistance=${dist};${lng},${lat}`;

  return axios.get(url, { validateStatus: status => status === 200 })
  .then((resXml) => {
    const resJson = x2js.xml_str2json(resXml.data).response.data.Station;
    return Array.isArray(resJson) ?
      resJson.map(station => station.station_id.slice(1)) :
      [resJson.station_id.slice(1)];
  });
};

const getFlights = (codes) => {
  const server = 'http://localhost:3001';
  const url = `${server}/flight`;
  return Promise.all(codes.map(code => axios.get(url, { params: { code } })));
};

const onSubmitCodes = () => {
  let codes = (el.textCodes.value.split(',').filter(str => str.length > 0));
  el.textCodes.value = codes.join(',');
  if (codes.length > 0) {
    console.log('Request flights for', codes);
    return getFlights(codes);
  }
};

const loadDependency = url => new Promise((resolve, reject) => {
  const scr = document.createElement('script');
  scr.onload = resolve;
  scr.src = url;
  document.body.appendChild(scr);
});

const dependencies = [
  'https://cdnjs.cloudflare.com/ajax/libs/axios/0.15.3/axios.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/x2js/1.2.0/xml2json.min.js',
];

Promise.all(dependencies.map(loadDependency))
.then(() => {
  x2js = new X2JS();
  return Promise.resolve();
})
.then(getUserLoc)
.then(getAirportCodes)
.then((codes) => {
  if (codes.length) el.textCodes.value = codes.join(',');
});
// .then(getFlights);

</script>
  </body>
</html>
